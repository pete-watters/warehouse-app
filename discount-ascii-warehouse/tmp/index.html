<!DOCTYPE html>
<html>
    <head>
        <title>Discount Ascii Warehouse</title>
    </head>
    <body>
        <header>
            <h1>Discount Ascii Warehouse</h1>

            <p>Here you're sure to find a bargain on some of the finest ascii available to purchase. Be sure to peruse our selection of ascii faces in an exciting range of sizes and prices.</p>

            <p>But first, a word from our sponsors:</p>
            <script>document.write('<img class="ad" src="/ad/?r=' + Math.floor(Math.random()*1000) + '"/>');</script>
        </header>

        <section class="products">
            <div id="products-table"></div>
        </section>

        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>


        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script>
            (function() {
                $.ajax({
                    type: "GET",
                    url: "/api/products",
                    dataType: "text",
                    success: function(resultData) {
                        var jsonString = "[" + resultData.replace(/\n/g, ",").slice(0, -1) + "]";
                        console.log($.parseJSON(jsonString));

                        var PRODUCT_JSON = $.parseJSON(jsonString);
                        // Draw GoogleTable
                        google.charts.load('current', {'packages':['table']});
                        google.charts.setOnLoadCallback(drawTable);



                        const formatPriceAsDollars = (inputPrice) =>{
                            return '$' + inputPrice + '.00';
                        };

                        var previousAdsUsed = [];

                        const randomNumberGenerator = () => {
                            const adID = Math.floor(Math.random()*1000);

                            // TODO - if this ad exists - is in the above list then re-generate it

                            return Math.floor(Math.random()*1000);
                        };

                        const insertAdvertisement = () => {
                            $('#products-table tbody tr:nth-child(2n)').after('<img class="ad" src="/ad/?r=' + randomNumberGenerator() + '"/>' );
                        };



                        function drawTable() {

                            console.log("In chart " + PRODUCT_JSON);


                            var data = new google.visualization.DataTable(
                                    {
                                        cols: [
                                                {id: 'face', label: 'Face', type: 'string'},
                                                {id: 'price', label: 'Price', type: 'string'},
                                                {id: 'size', label: 'Size', type: 'number'},
                                                {id: 'date', label: 'Date', type: 'date'},
                                                {id: 'id', label: 'Product ID', type: 'string'}
                                        ]
                                    }
                            );


                            for(var i = 0; i < PRODUCT_JSON.length; i++){
                                let formattedDate;
                                // TODO - move to a function - do a date check  here maybe to insert a f value for e.g. X days ago
                                if(1 === 1){
                                    formattedDate = {v: new Date(PRODUCT_JSON[i]["date"]),f: 'January First, Nineteen ninety-nine'};
                                }else{
                                    formattedDate= PRODUCT_JSON[i]["date"];
                                }



                                data.addRow([ PRODUCT_JSON[i]["face"] ,  formatPriceAsDollars(PRODUCT_JSON[i]["price"]) , PRODUCT_JSON[i]["size"] , formattedDate , PRODUCT_JSON[i]["id"] ]);
                                // TODO if the row count is 20 we need to insert an advertisement


                            }

                            if(PRODUCT_JSON.length >= 20){
                                // need to show and ad after every 20 rows
                                var remainder = i % 20;
                                if(remainder === 0){
                                    insertAdvertisement();
                                }
                            }


                            var table = new google.visualization.Table(document.getElementById('products-table'));

//                            TODO set a fixed height here so you can scroll down and read more

                            table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});

// TODO - onclick of sorting needs to make an API call again to get data sorted by server
// should turn off sorting locally
//  I would suggest, however, that you investigate implementing server-side paging via AJAX calls.
// Set up a script or servlet that hands out data in pieces, and an AJAX function on the client-side
// that calls the server for the next piece of data (it could be one page, 5 pages, 100 pages,
// whatever is most convenient for your application), and fills in the table piece-by-piece.
                        }

//                        TODO - paging scroll
//                        https://github.com/hashchange/jquery.isinview
// TODO - onscroll just redraw full table
//                        http://stackoverflow.com/questions/11473143/jquery-automatically-scrolling-table-rows-but-with-table-header-fixed




                    },
                    error : function(jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR + textStatus + errorThrown);
                    }
                });
            })();
        </script>

        </body>
</html>
